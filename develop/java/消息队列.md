一些列问题-参考<https://github.com/doocs/doocs.github.io/blob/master/README_CN.md>

- 项目中什么场景使用了MQ，解决哪些问题？如果不用MQ，有其他解决方案吗（对比优劣）？

- MQ的常用场景？

  - 解耦
  - 异步
  - 削峰

- MQ带来的问题

  - MQ如何保证高可用（High Ability）？

  - 保证不重复消费？（如何保证消息消费的幂等性）

    - 什么是幂等？

      > 在某二元运算下，幂等元素是指被自己重复运算（或对于函数是为复合）的结果等于它自己的元素。例如：乘法下的唯一两个幂等实数0和1 
      >
      > 延伸到编程幂等性指：对同一个系统，使用同样的条件，一次请求和重复的多次请求对系统资源的影响是一致的（相当于重复消费一条消息多次无影响）

    - 哪些场景会有重复消费的问题？

      - 例01：Kafka出现重复消费的场景

    - 结合业务确认处理思路：

      - 比如你拿个数据要写库，你先根据主键查一下，如果这数据都有了，你就别插入了，update 一下好吧。
      - 比如你是写 Redis，那没问题了，反正每次都是 set，天然幂等性。
      - 比如你不是上面两个场景，那做的稍微复杂一点，你需要让生产者发送每条数据的时候，里面加一个全局唯一的 id，类似订单 id 之类的东西，然后你这里消费到了之后，先根据这个 id 去比如 Redis 里查一下，之前消费过吗？如果没有消费过，你就处理，然后这个 id 写 Redis。如果消费过了，那你就别处理了，保证别重复处理相同的消息即可。
      - 比如基于数据库的唯一键来保证重复数据不会重复插入多条。因为有唯一键约束了，重复数据插入只会报错，不会导致数据库中出现脏数据。

  - 如何保证消息的可靠性传输？（如何处理消息丢失的问题）

    - 出现丢失的环节：生产者、MQ、消费者

    - RabbitMQ 的丢失情况：【生产者】-->【MQ】-->【消费者】

      - 生产者将数据发送至MQ 数据在途中被弄丢（如：网络问题造成...）

        - 问题原因：从生产者发送数据开始---到---MQ收到消息完毕，期间无异常

        - 解法01：RabbitMQ提供的事务功能：

          ```java
          // 开启事务
          channel.txSelect
          try {
              // 这里发送消息
          } catch (Exception e) {
              channel.txRollback
          
              // 这里再次重发这条消息
          }
          
          // 提交事务
          channel.txCommit
          ```

          - 弊端：RabbitMQ 事务机制（同步）一搞，基本上**吞吐量会下来，因为太耗性能**

        - 解法02：开启`confirm`模式

    - Kafka 的丢失情况：

  - 如何解决消息队列的延时以及过期失效问题？消息队列满了以后该怎么处理？有几百万消息持续积压几小时，说说怎么解决？

  - 保证顺序消费？

  - 如果消费时出现异常，怎么处理？

- 分布式事务如何处理

  - 实例1：绩效系统2位二考同时审批，同步数据状态到PS系统数据库
  - 实例2：绩效系统更换审批人，同步数据到任务系统，任务系统入库后，通过mq同步数据到绩效系统

- SF系统间大量的使用Kafka 同步数据？

  - 期间有系统将mq取消，改为调用接口同步返回数据。愚蠢？
